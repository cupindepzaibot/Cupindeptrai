import os
import csv
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters
)

# Táº¡o cÃ¡c tá»‡p tin cáº§n thiáº¿t (CSV) náº¿u chÆ°a cÃ³
DATA_FILE = "users_data.csv"

# HÃ m thÃªm ngÆ°á»i dÃ¹ng vÃ o file CSV
def add_user_to_csv(user_id, username):
    if not os.path.exists(DATA_FILE):
        # Táº¡o tá»‡p má»›i vÃ  thÃªm header náº¿u khÃ´ng tá»“n táº¡i
        with open(DATA_FILE, mode='w', newline='', encoding='utf-8') as file:
            writer = csv.writer(file)
            writer.writerow(["User ID", "Username", "Timestamp"])
    
    # ThÃªm thÃ´ng tin ngÆ°á»i dÃ¹ng vÃ o file CSV
    with open(DATA_FILE, mode='a', newline='', encoding='utf-8') as file:
        writer = csv.writer(file)
        writer.writerow([user_id, username, datetime.now().strftime("%Y-%m-%d %H:%M:%S")])

# HÃ m xá»­ lÃ½ lá»‡nh /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.message.from_user.id
    username = update.message.from_user.username
    
    # LÆ°u thÃ´ng tin ngÆ°á»i dÃ¹ng vÃ o CSV
    add_user_to_csv(user_id, username)

    # Táº¡o bÃ n phÃ­m inline
    keyboard = [
        [InlineKeyboardButton("ğŸ›’ Mua sáº£n pháº©m", callback_data='buy')],
        [InlineKeyboardButton("ğŸ“„ Lá»‹ch sá»­ mua hÃ ng", callback_data='history')],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    # Gá»­i tin nháº¯n chÃ o má»«ng
    await update.message.reply_text(
        f"ChÃ o <b>{username}</b>! ChÃºc báº¡n cÃ³ nhá»¯ng tráº£i nghiá»‡m tuyá»‡t vá»i.\n\nChá»n má»™t trong cÃ¡c tÃ¹y chá»n dÆ°á»›i Ä‘Ã¢y:",
        reply_markup=reply_markup,
        parse_mode='HTML'
    )

# HÃ m xá»­ lÃ½ lá»‡nh /help
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text("ÄÃ¢y lÃ  bot máº«u. Sá»­ dá»¥ng cÃ¡c lá»‡nh sau:\n/start - Báº¯t Ä‘áº§u sá»­ dá»¥ng bot.\n/help - HÆ°á»›ng dáº«n sá»­ dá»¥ng.")

# HÃ m xá»­ lÃ½ hÃ nh Ä‘á»™ng tá»« InlineKeyboard
async def button(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()  # Tráº£ lá»i callback query

    if query.data == 'buy':
        # TÃ¹y chá»‰nh hÃ nh Ä‘á»™ng khi ngÆ°á»i dÃ¹ng chá»n "Mua sáº£n pháº©m"
        await query.edit_message_text(text="ğŸ›’ Báº¡n Ä‘Ã£ chá»n mua sáº£n pháº©m.")
    elif query.data == 'history':
        # TÃ¹y chá»‰nh hÃ nh Ä‘á»™ng khi ngÆ°á»i dÃ¹ng chá»n "Lá»‹ch sá»­ mua hÃ ng"
        await query.edit_message_text(text="ğŸ“œ ÄÃ¢y lÃ  lá»‹ch sá»­ mua hÃ ng cá»§a báº¡n.")

# HÃ m Ä‘á»c lá»‹ch sá»­ mua hÃ ng tá»« file CSV
def get_purchase_history(user_id):
    history = []
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, mode='r', newline='', encoding='utf-8') as file:
            reader = csv.reader(file)
            for row in reader:
                if row[0] == str(user_id):  # Kiá»ƒm tra ID ngÆ°á»i dÃ¹ng
                    history.append(row)
    return history

# HÃ m hiá»ƒn thá»‹ lá»‹ch sá»­ mua hÃ ng
async def show_purchase_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.message.from_user.id
    history = get_purchase_history(user_id)
    if history:
        message = "ğŸ“œ Lá»‹ch sá»­ mua hÃ ng cá»§a báº¡n:\n"
        for record in history:
            message += f"Thá»i gian: {record[2]}\nSáº£n pháº©m: {record[1]}\n---\n"
    else:
        message = "Báº¡n chÆ°a cÃ³ lá»‹ch sá»­ mua hÃ ng."

    await update.message.reply_text(message)

# Main function Ä‘á»ƒ cáº¥u hÃ¬nh vÃ  cháº¡y bot
async def main() -> None:
    # Táº¡o á»©ng dá»¥ng bot
    application = ApplicationBuilder().token('YOUR_BOT_TOKEN').build()
    # ÄÄƒng kÃ½ cÃ¡c handler cho bot
    application.add_handler(CommandHandler('start', start))
    application.add_handler(CommandHandler('help', help_command))
    application.add_handler(CallbackQueryHandler(button))
    application.add_handler(MessageHandler(filters.Text, show_purchase_history))

    # Cháº¡y bot
    await application.run_polling()

# Äá»ƒ cháº¡y bot, gá»i hÃ m main() khi script Ä‘Æ°á»£c cháº¡y
if __name__ == '__main__':
    import asyncio
    asyncio.run(main())
